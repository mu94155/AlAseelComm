# نظام مدفوعات المراحل بناءً على نسبة الإنجاز

## نظرة عامة
تم تحديث نظام إدارة المصاريف ليستخدم نسبة إنجاز المشروع بدلاً من التواريخ الثابتة لتحديد موعد دفع كل مرحلة. هذا النهج يوفر مرونة أكبر ويربط المدفوعات بالتقدم الفعلي للمشروع.

## الملفات المحدثة

### 1. JS/expensesManager.js
- **تغيير هيكل البيانات**: استبدال `dueDate` بـ `completionPercentage` في كائنات المراحل
- **إضافة وظائف جديدة**:
  - `shouldShowPaymentButton()`: تحدد ما إذا كان يجب إظهار زر الدفع
  - `markMilestoneAsPaid()`: تسجيل دفع المرحلة
  - `getCurrentProjectCompletion()`: حساب نسبة إنجاز المشروع الحالية
- **تحديث التحقق من صحة البيانات**: التأكد من أن نسبة الإنجاز بين 1-100%

### 2. expenses-management.html
- تحديث نموذج إضافة المراحل لاستخدام حقل نسبة الإنجاز
- إضافة أزرار تأكيد الدفع التي تظهر عند الوصول للنسبة المطلوبة
- تحديث عرض المراحل لإظهار نسبة الإنجاز المطلوبة

### 3. project-expenses.html
- تحديث النموذج ليشمل حقل نسبة الإنجاز
- تحديث عرض المراحل النموذجية لإظهار النسب بدلاً من التواريخ

## كيفية عمل النظام الجديد

### 1. إضافة مرحلة جديدة
```javascript
const milestone = {
    id: Date.now(),
    title: "عنوان المرحلة",
    amount: 100000,
    completionPercentage: 30, // يُدفع عند الوصول لـ 30% من إنجاز المشروع
    description: "وصف المرحلة",
    status: "scheduled",
    isPaid: false,
    expenses: []
};
```

### 2. حساب نسبة الإنجاز
نسبة الإنجاز تُحسب بناءً على:
```javascript
const completionPercentage = (totalExpended / totalBudget) * 100;
```

### 3. تحديد أهلية الدفع
```javascript
shouldShowPaymentButton(milestone) {
    const currentCompletion = this.getCurrentProjectCompletion();
    return !milestone.isPaid && 
           currentCompletion >= milestone.completionPercentage;
}
```

## المراحل الافتراضية

### المرحلة الأولى (30%)
- **المبلغ**: 800,000 ر.ع
- **الوصف**: الأساسات والهيكل الأساسي
- **يُدفع عند**: الوصول لـ 30% من إنجاز المشروع

### المرحلة الثانية (70%)
- **المبلغ**: 950,000 ر.ع
- **الوصف**: البناء والتشطيبات الأساسية
- **يُدفع عند**: الوصول لـ 70% من إنجاز المشروع

### المرحلة الثالثة (100%)
- **المبلغ**: 750,000 ر.ع
- **الوصف**: التشطيبات النهائية
- **يُدفع عند**: إكمال المشروع بنسبة 100%

## المزايا الجديدة

### 1. المرونة في التوقيت
- لا توجد تواريخ ثابتة للدفع
- المدفوعات تتبع التقدم الفعلي للمشروع
- إمكانية تسريع أو تأخير المراحل حسب سير العمل

### 2. التحكم التلقائي
- أزرار الدفع تظهر تلقائياً عند الوصول للنسبة المطلوبة
- منع الدفع المبكر للمراحل
- تتبع دقيق لحالة كل مرحلة

### 3. الشفافية
- عرض واضح لنسبة الإنجاز المطلوبة لكل مرحلة
- مؤشر التقدم يُحدث في الوقت الفعلي
- معلومات مفصلة عن كل مرحلة

## واجهة المستخدم

### عرض المراحل
```html
<p class="mt-2 small text-muted">
    ${milestone.paymentDate ? 
        `تاريخ الدفع: ${new Date(milestone.paymentDate).toLocaleDateString('ar-EG')}` : 
        `يُدفع عند الوصول إلى: ${milestone.completionPercentage}% من المشروع`
    }
</p>
```

### زر تأكيد الدفع
```html
${this.shouldShowPaymentButton(milestone) ? `
    <button type="button" class="btn btn-success btn-sm mt-2" 
            onclick="expensesManager.markMilestoneAsPaid(${milestone.id})">
        <i class="bi bi-check-circle"></i> تأكيد الدفع
    </button>
` : ''}
```

## الاستخدام

1. **إضافة مرحلة جديدة**: استخدم النموذج مع حقل نسبة الإنجاز (1-100%)
2. **متابعة التقدم**: مراقبة شريط التقدم الذي يُحدث تلقائياً
3. **تأكيد الدفع**: الضغط على زر "تأكيد الدفع" عند ظهوره
4. **مراجعة المراحل**: عرض جميع المراحل وحالاتها في الصفحة الرئيسية

## التحديثات المستقبلية المقترحة

1. **إشعارات تلقائية** عند الوصول لنسبة إنجاز مرحلة معينة
2. **تقارير تفصيلية** عن تقدم المشروع ومراحل الدفع
3. **تكامل مع أنظمة المحاسبة** الخارجية
4. **نسخ احتياطية تلقائية** للبيانات المهمة

---

*تم إنشاء هذا المستند في: ${new Date().toLocaleDateString('ar-EG')}*
